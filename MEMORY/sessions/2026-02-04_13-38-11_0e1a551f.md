---
session_id: 0e1a551f-cdaf-4893-ab0b-f399dc852986
timestamp: 2026-02-04T13:38:11
project: sistema-os
cwd: /home/marketing/sistema-os
source: agent
---

# Session 0e1a551f

**Date:** 2026-02-04 | **Project:** sistema-os

## Summary

Resolvido definitivamente o problema de timeout do pipeline_diario (~2h) migrando o cliente Supabase de síncrono para assíncrono. Pipeline agora executa em ~22min. Também migrado preventivamente o job hospedes_casa e documentado o padrão async como obrigatório no projeto.

## What Was Done

- Diagnosticado root cause: `httpx.Client()` síncrono bloqueava event loop, impedindo cancelamento
- Criado `AsyncQueryBuilder` com `httpx.AsyncClient()` em `app/core/supabase.py`
- Adicionado método `async_table()` para uso em código assíncrono
- Migrado 7 arquivos para usar `await async_table().execute()`:
  - base_orchestrator.py
  - listagem_hospedes_orchestrator.py
  - hospede_matcher.py
  - snapshot_manager.py
  - suggestion_manager.py
  - pipeline_diario_job.py
- Adicionado heartbeat a cada 30s no pipeline para observabilidade
- Criado testes em `backend/tests/test_supabase_async.py`
- Documentado padrão em `docs/LEARNINGS.md` como OBRIGATÓRIO
- Documentado decisão em ADR-025 em `docs/modules/os/DECISIONS.md`
- Merge de development para main

## Decisions Made

- **async_table() obrigatório**: Em funções `async def`, sempre usar `await async_table().execute()`
- **Heartbeat 30s**: Pipeline loga posição a cada 30s para rastrear onde está
- **Timeout 30s por query**: Reduzido de 60s para falhar mais rápido

## Files Modified

- `app/core/supabase.py` - AsyncQueryBuilder + async_table()
- `app/jobs/pipeline_diario_job.py` - heartbeat + async
- `app/services/orchestration/base_orchestrator.py`
- `app/services/orchestration/listagem_hospedes_orchestrator.py`
- `app/services/matching/hospede_matcher.py`
- `app/services/matching/suggestion_manager.py`
- `app/services/diff_detection/snapshot_manager.py`
- `backend/tests/test_supabase_async.py` (novo)
- `docs/LEARNINGS.md`
- `docs/modules/os/DECISIONS.md`

## Learnings

- Cliente HTTP síncrono (`httpx.Client`) em código async bloqueia event loop e impede `asyncio.wait_for()` de cancelar
- Timeout de ~2h coincidia com `STALE_RUNNING_HOURS` do cleanup, não com timeout configurado (90min)
- `rm_daily_collection` não tem o problema porque usa `asyncio.create_subprocess_exec()` (processo separado)

## Next Steps

- Monitorar próximas execuções do pipeline_diario para confirmar fix em produção
- Verificar se heartbeat aparece nos logs corretamente
- Considerar migrar outros arquivos que usem `.table()` em contexto async

---
*Session summary by Claude (/fim)*
